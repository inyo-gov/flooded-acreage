# Flooded Acreage Monitoring Dashboard

This project provides automated monitoring of flooded acreage in the Blackrock Waterfowl Management Area using Sentinel-2 optical and Sentinel-1 SAR satellite imagery. The system generates both individual flood reports and a comprehensive dashboard with time series visualization. Sentinel-1 SAR processing enables detection of flooding under emergent vegetation, complementing the optical Sentinel-2 approach.

Currently the requirement to quantify flooded acreage has been implemented by field workers physically walking the wetted extent with a handheld GPS, which can take up to 8 person days in the field every time it is needed. The current requirements mandate this be done around November 1 and March 1 time periods. This application provides: 1) instantaneous flooded acreage estimates for the Nov 1 and Mar 1 periods, rather than multiple days of field work, and 2) acreage estimates throughout the year, every five days or whenever cloud-free Sentinel scenes are available. 

Sentinel 2 provides 10m resolution in Band 8 near-infrared, whereas Landsat resolution is 30m. The improved resolution of Sentinel over Landsat and improvements in availability of this imagery from earth engine's archive drove the development of this work. There are thousands of papers, and dozens of water indices used to quantify open water, yet they all use some combination of near infrared, short-wave infrared, or ratios of these. Here a simple thresholding of NIR is where I've started and it yields good results with a few validation points that will be obtained for the official Nov 1 and Mar 1 time periods to help calibrate the threshold for reporting purposes.

## Dashboard

The project includes a comprehensive dashboard that displays:

- **Time Series Plot**: Monthly flooded acreage trends by unit
- **Interactive Table**: Links to all historical reports organized by fiscal year
- **Current Report Display**: Embedded iframe showing the most recent flood report

Access the dashboard at: `docs/index.html`

## Individual Reports

Here is an example of an individual flood report generated by the project:

![Example Report](images/report_example.png)

## Table of Contents

- [Introduction](#introduction)
- [Setup and Installation](#setup-and-installation)
- [Usage](#usage)
- [Example Analysis](#example-analysis)
- [Technical Notes](#technical-notes)
- [License](#license)

## Introduction

This project is designed to compute the flooded acreage within specified units using multiple satellite data sources:

**Sentinel-2 (Optical)**: 
- Filtering imagery based on cloud cover and dates
- Applying a threshold to the NIR band to identify flooded areas
- Excellent for open water detection

**Sentinel-1 (SAR)**:
- Change detection comparing wet period to dry baseline
- Sensitive to water under emergent vegetation (cattails, etc.)
- Uses VV and VH backscatter differences

**Fusion**:
- Combines both S1 and S2 results for comprehensive flood mapping
- Multiple fusion modes: union, intersection, or confidence classes

The analysis calculates the area of flooded pixels within predefined units and generates visual and tabular reports.

## Setup and Installation

### Prerequisites

- Python 3.x
- Google Earth Engine API
- Geopandas
- Geemap
- Pandas
- Folium

### Installation

1. Clone the repository:

   ```sh
   git clone https://github.com/inyo-gov/flooded-acreage.git
   cd flooded-acreage
   ```

2. Create and activate a virtual environment:

   ```sh
   python -m venv venv
   source venv/bin/activate  # On Windows use `venv\Scripts\activate`
   ```

3. Install the required libraries:

   ```sh
   pip install -r requirements.txt
   ```

4. Authenticate with Google Earth Engine:

   ```sh
   earthengine authenticate
   ```

## Usage

### Generate Sentinel-2 Flood Report

Use the Python script to generate a flood report from Sentinel-2 optical imagery:

```sh
python flood_report.py <date> <threshold>
```

Example:
```sh
python flood_report.py '2025-09-17' 0.15
```

### Generate Sentinel-1 SAR Flood Report

Generate a flood report using Sentinel-1 SAR data (useful for detecting flooding under vegetation):

```sh
python flood_report_s1.py <start_date> <dry_start> <dry_end> [--dvv-thresh] [--vv-vh-ratio] [--orbit-pass]
```

Example:
```sh
python flood_report_s1.py '2024-10-22' '2024-08-01' '2024-08-31' --dvv-thresh -1.5
```

**Parameters:**
- `start_date`: Start date for wet/flood period (YYYY-MM-DD)
- `dry_start`: Start date for dry baseline period (YYYY-MM-DD)
- `dry_end`: End date for dry baseline period (YYYY-MM-DD)
- `--dvv-thresh`: dVV threshold in dB (default: -1.5). Lower values = more sensitive
- `--vv-vh-ratio`: Maximum VV-VH ratio in dB (default: 3)
- `--orbit-pass`: Filter by orbit direction: ASCENDING or DESCENDING (optional)

### Generate Fused S1+S2 Report

Combine Sentinel-1 and Sentinel-2 results for comprehensive flood mapping:

```sh
python flood_report_fusion.py <start_date> <s2_threshold> <dry_start> <dry_end> [--s1-thresh] [--fusion-mode] [--orbit-pass]
```

Example:
```sh
python flood_report_fusion.py '2024-10-22' 0.22 '2024-08-01' '2024-08-31' --fusion-mode union
```

**Fusion Modes:**
- `union` (default): Flood if either S1 or S2 detects it
- `intersection`: Flood only if both S1 and S2 detect it (conservative)
- `confidence`: Create confidence classes (1=S2-only, 2=S1-only, 3=both)

**Parameters:**
- `start_date`: Start date for wet/flood period (YYYY-MM-DD)
- `s2_threshold`: S2 NIR threshold (same as flood_report.py)
- `dry_start`: Start date for S1 dry baseline period (YYYY-MM-DD)
- `dry_end`: End date for S1 dry baseline period (YYYY-MM-DD)
- `--s1-thresh`: S1 dVV threshold in dB (default: -1.5)
- `--vv-vh-ratio`: S1 VV-VH ratio threshold in dB (default: 3)
- `--fusion-mode`: Fusion mode: union, intersection, or confidence (default: union)
- `--orbit-pass`: S1 orbit pass direction: ASCENDING or DESCENDING (optional)

### View the Dashboard

The dashboard is automatically generated and available at:
- Local: `docs/index.html`
- GitHub Pages: `https://inyo-gov.github.io/flooded-acreage/`

### Update the Dashboard

After generating new reports, update the dashboard:

```sh
quarto render index.qmd
```

### Parameters

- **Surface Reflectance Threshold**: A value to threshold the NIR band for water detection.
- **Start Date**: The starting date for filtering Sentinel-2 imagery.
- **End Date**: Computed as start date + 15 days.
- **Bounding Box Coordinates**: Define the area of interest for the analysis.

### Example

```python
# Parameters
threshold = .16
start_date = '2024-06-06'

# Compute the end date
end_date = (datetime.strptime(start_date, '%Y-%m-%d') + timedelta(days=15)).strftime('%Y-%m-%d')

# Define the bounding box coordinates
bbox = [[-118.23240736400778, 36.84651455123723],
        [-118.17232588207419, 36.84651455123723],
        [-118.17232588207419, 36.924364295139625],
        [-118.23240736400778, 36.924364295139625]]
```

## Example Analysis

### Step 1: Import Libraries

```python
import ee
import geopandas as gpd
import geemap
import pandas as pd
import folium
import geemap.foliumap as geemap
from datetime import datetime, timedelta
import os
```

### Step 2: Authenticate and Initialize Earth Engine

```sh
# Run this in terminal to authenticate with gcloud
earthengine authenticate
```

```python
# Initialize Earth Engine
ee.Initialize()
```

### Step 3: Filter and Process Imagery

```python
# Filter sentinel 2 surface reflectance imagery
sentinel_collection = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED') \
    .filterBounds(bounding_box_geometry) \
    .filterDate(start_date, end_date) \
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 30)) \
    .select(['B8', 'SCL'])  # Select NIR band (B8) and Scene Classification Layer (SCL) for masking clouds
```

### Step 4: Generate Reports

#### HTML Map

```python
# Create and save HTML map
Map.save(map_filename)
```

#### HTML Report

```python
# Create HTML report
html_report = f"""
<html>
<head>
    <title>BWMA Flooded Extent: {image_date_str}</title>
    <style>
        body {{
            font-family: Arial, sans-serif;
        }}
        .container {{
            display: flex;
            justify-content: space-between;
        }}
        .left {{
            width: 25%;
        }}
        .right {{
            width: 75%;
            text-align: center;
        }}
        h1, h2 {{
            text-align: center;
        }}
        .notes {{
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #000;
        }}
        table {{
            width: 90%;
            font-size: 50px;
            border-collapse: collapse;
        }}
        th, td {{
            padding: 20px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }}
        th {{
            text-align: right;//from center
            font-size: 30px;
        }}
        td:nth-child(2) {{
            text-align: right;
        }}
        tr:last-child {{
            font-weight: bold;
            font-size: 80px;
        }}
        tr:last-child td {{
            border-top: 3px solid #000;
        }}
    </style>
</head>
<body>
    <h1>BWMA Flooded Acres and Extent: {image_date_str}</h1>
    <div class="container">
        <div class="left">
            <h2>Flooded Acres</h2>
            {html_table_simple}
        </div>
        <div class="right">
            <h2>Spatial Extent</h2>
            <p>Imagery Date: {image_date_str}</p>
            <iframe src="flooded_area_map_{image_date_str}_{threshold}.html" width="90%" height="500"></iframe>
        </div>
    </div>
    <div class="notes">
        <h3>Technical Notes</h3>
        <p>Flooded acres were calculated from Sentinel-2 Surface Reflectance imagery using the Earth Engine Python API in a Jupyter notebook.  Sentinel-2 (S2) is a wide-swath, high-resolution, multispectral imaging mission with a global 5-day revisit frequency.</p>
        <p>The S2 Multispectral Instrument (MSI) samples 13 spectral bands: Visible and NIR at 10 meters, red edge and SWIR at 20 meters, and atmospheric bands at 60 meters spatial resolution. The Near Infrared (NIR) band was used to identify flooded areas by applying a threshold to isolate water.</p>
        <p>The results are validated during routine field checks throughout the seasonal flooding cycle September through April.</p>
    </div>
</body>
</html>
"""
```

# Save the report to an HTML file
with open(report_filename, "w") as file:
    file.write(html_report)

### Project Structure

```
flooded-acreage/
├── flood_report.py          # Sentinel-2 optical flood mapping script
├── flood_report_s1.py       # Sentinel-1 SAR flood mapping script
├── flood_report_fusion.py  # Fused S1+S2 flood mapping script
├── sar_utils.py            # SAR processing utility functions
├── dem_utils.py            # DEM utilities (for future use)
├── index.qmd               # Quarto source for the dashboard
├── _quarto.yml            # Quarto configuration
├── docs/                  # Generated website files
│   ├── index.html        # Main dashboard
│   ├── reports/          # Individual flood reports
│   ├── csv_output/       # CSV data files
│   └── index_files/      # Plot images
├── requirements.txt       # Python dependencies
└── README.md            # This file
```

### Complete Workflow

1. **Generate new report**:
   ```sh
   python flood_report.py '2025-09-17' 0.15
   ```

2. **Update dashboard**:
   ```sh
   quarto render index.qmd
   ```

3. **View results**:
   - Open `docs/index.html` in your browser
   - Or push to GitHub for GitHub Pages hosting

## Example Output

Here's an example of what you might see when you run the script:

![Example Report](images/cli_python_with_parameters.png)

## Technical Notes

### Sentinel-2 (Optical)
- **Surface Reflectance Imagery**: Uses Sentinel-2 SR imagery for its high resolution (10m) and frequent revisit time (5 days).
- **Flood Detection**: NIR band thresholding identifies open water effectively.
- **Limitations**: Cannot detect flooding under dense emergent vegetation (e.g., cattails).

### Sentinel-1 (SAR)
- **Synthetic Aperture Radar**: C-band SAR is sensitive to water under vegetation due to double-bounce scattering.
- **Change Detection**: Compares wet period backscatter to a dry baseline period.
- **Flood Indicators**: 
  - dVV (change in VV backscatter): Flooded areas show decreased VV (typically < -1.5 dB)
  - VV/VH ratio: Flooded vegetation shows altered polarization ratios
- **Baseline Period**: Requires a dry baseline period (typically summer months) for comparison.

### Fusion
- **Complementary Sensors**: S2 excels at open water, S1 detects under-vegetation flooding.
- **Fusion Modes**: 
  - Union captures maximum flood extent
  - Intersection provides conservative estimates
  - Confidence classes help identify detection method

### General
- **Google Earth Engine API**: All analysis performed using the Earth Engine Python API for processing large geospatial datasets.
- **Dashboard Technology**: The dashboard is built with Quarto, providing interactive time series visualization and report management.
- **Data Management**: Historical data is automatically tracked and visualized in the dashboard.
- **Reports**: Individual HTML reports are generated for each analysis, with CSV data export capabilities.
- **Field Validation**: Results are validated during routine field checks throughout the seasonal flooding cycle (September through April). Field data collection in ArcGIS Online will inform future threshold calibration and relative elevation analysis needs.

## License

This project is licensed under the MIT License. See the LICENSE file for details.

